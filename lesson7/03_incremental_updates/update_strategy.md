# 教程：知识库增量索引与定期重训练策略

## 学习目标
- 识别新文档、更新文档、删除文档的增量更新流程。
- 根据变更比例决定是否触发检索器或重排序模型的重训练。
- 记录更新计划与审计日志，确保知识库维护可追溯。

## 背景原理
知识库在上线后会持续更新，需避免全量重建的高成本。常见策略：
1. **增量写入**：仅写入新/更新文档，同时删除过期文档。
2. **重训练判定**：依据变更比例或质量指标决定是否启动模型重训练。
3. **审计记录**：记录更新内容、时间、操作人，满足合规要求。

## 代码结构解析
- `DocumentRecord` / `UpdatePlan`：描述文档与更新计划结构。
- `detect_changes`：对比旧索引与新语料，生成新增/更新/删除列表，并计算变更比例。
- `apply_plan`：将更新计划写入本地 JSON 索引，模拟增量维护。
- `simulate_retraining`：根据 `need_retrain` 输出提示并记录日志。
- `main`：加载输入、执行计划并打印变更统计。

## 实践步骤
1. 准备现有索引 `index.json` 与最新语料 `corpus.json`，格式为 `doc_id -> 文本`。
2. 运行脚本：
   ```bash
   python update_strategy.py index.json corpus.json --log update_log.json
   ```
3. 查看控制台输出的新增、更新、删除文档列表，以及是否需要重训练。
4. 检查 `update_log.json`，确认日志包含变更明细，可用于后续审计。

## 拓展问题
- 如何结合 Embedding 的距离变化判断文档是否需要重编码？
- 当知识库规模庞大时，可否按主题/时间分批更新以减少影响？
- 可否将更新计划与 CI/CD 流程结合，实现自动触发重训练与部署？
